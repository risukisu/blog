---
import '../styles/global.css';
import type { ImageMetadata } from 'astro';
import FallbackImage from '../assets/blog-placeholder-1.jpg';
import { SITE_TITLE } from '../consts';

interface Props {
	title: string;
	description: string;
	image?: ImageMetadata;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = FallbackImage } = Astro.props;
---

<!-- Google Analytics (consent-gated) -->
<script is:inline>
	(function() {
		var GA_ID = 'G-TN2YY0219L';
		var consent = localStorage.getItem('cookie-consent');
		if (consent === 'accepted') {
			var s = document.createElement('script');
			s.async = true;
			s.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
			document.head.appendChild(s);
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			window.gtag = gtag;
			gtag('js', new Date());
			gtag('config', GA_ID);
		}
	})();
</script>

<!-- Cookie Consent Banner -->
<script is:inline>
	(function() {
		var consent = localStorage.getItem('cookie-consent');
		if (consent) return;

		document.addEventListener('DOMContentLoaded', function() {
			var banner = document.createElement('div');
			banner.id = 'cookie-banner';
			banner.innerHTML =
				'<div class="cookie-inner">' +
					'<span class="cookie-msg">[COOKIE] this site uses cookies for analytics. </span>' +
					'<div class="cookie-buttons">' +
						'<button id="cookie-accept" class="cookie-btn accept">[accept]</button>' +
						'<button id="cookie-decline" class="cookie-btn decline">[decline]</button>' +
					'</div>' +
				'</div>';
			document.body.appendChild(banner);

			document.getElementById('cookie-accept').addEventListener('click', function() {
				localStorage.setItem('cookie-consent', 'accepted');
				banner.remove();
				var GA_ID = 'G-TN2YY0219L';
				var s = document.createElement('script');
				s.async = true;
				s.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
				document.head.appendChild(s);
				window.dataLayer = window.dataLayer || [];
				function gtag(){dataLayer.push(arguments);}
				window.gtag = gtag;
				gtag('js', new Date());
				gtag('config', GA_ID);
			});

			document.getElementById('cookie-decline').addEventListener('click', function() {
				localStorage.setItem('cookie-consent', 'declined');
				banner.remove();
			});
		});
	})();
</script>
<style>
	#cookie-banner {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		z-index: 9999;
		background: var(--bg-surface);
		border-top: 1px solid var(--cyan);
		padding: 1em;
		font-family: "JetBrains Mono", monospace;
		font-size: 0.85em;
	}
	.cookie-inner {
		max-width: 720px;
		margin: 0 auto;
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1em;
		flex-wrap: wrap;
	}
	.cookie-msg {
		color: var(--text);
	}
	.cookie-buttons {
		display: flex;
		gap: 0.5em;
		flex-shrink: 0;
	}
	.cookie-btn {
		font-family: "JetBrains Mono", monospace;
		font-size: 1em;
		border: 1px solid var(--border);
		padding: 0.3em 0.8em;
		cursor: pointer;
		border-radius: 2px;
		transition: color 0.2s, border-color 0.2s, text-shadow 0.2s;
		background: none;
		min-height: 44px;
	}
	.cookie-btn.accept {
		color: var(--green);
		border-color: var(--green);
	}
	.cookie-btn.accept:hover {
		text-shadow: var(--glow-green);
	}
	.cookie-btn.decline {
		color: var(--text-muted);
	}
	.cookie-btn.decline:hover {
		color: var(--magenta);
		border-color: var(--magenta);
		text-shadow: var(--glow-magenta);
	}
</style>

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="icon" href="/favicon.ico" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link
	rel="alternate"
	type="application/rss+xml"
	title={SITE_TITLE}
	href={new URL('rss.xml', Astro.site)}
/>
<meta name="generator" content={Astro.generator} />

<!-- Theme: prevent flash -->
<script is:inline>
	(function() {
		const theme = localStorage.getItem('theme');
		if (theme === 'light') {
			document.documentElement.classList.add('light');
		}
	})();
</script>

<!-- Font preloads -->
<link rel="preload" href="/fonts/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin />
<link rel="preload" href="/fonts/JetBrainsMono-Bold.woff2" as="font" type="font/woff2" crossorigin />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image.src, Astro.url)} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image.src, Astro.url)} />
